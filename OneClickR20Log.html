<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ì›í´ë¦­ ë¡¤20 ìŠ¤íƒ€ì¼</title>
  <style>
    @font-face {
      font-family: 'Pretendard-Regular';
      src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Pretendard-Regular';
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      padding: 20px;
      background-color: #f7f7f7;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .drop-zone {
      border: 2px dashed #aaa;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: #666;
      background-color: #fff;
      transition: background-color 0.3s, border-color 0.3s;
      cursor: pointer;
    }

    .drop-zone.dragover {
      background-color: #eef6ff;
      border-color: #3399ff;
      color: #3399ff;
    }

    .preview-container {
      flex: 1;
      height: 100%;
      overflow: auto;
      background-color: #1f1e22;
      color: white;
      padding: 10px;
    }

    #preview {
      flex: 1;
      width: 100%;
      height: 100%;
    }

    button {
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
    }

    label {
      font-size: 14px;
    }

    input[type="number"] {
      width: 60px;
      padding: 5px;
      margin-left: 5px;
    }

    .CodeMirror {
      height: 100px !important;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <!-- âœ… CodeMirror 5 CSS & JS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

  <!-- âœ… ì„ íƒì ìœ¼ë¡œ HTML ëª¨ë“œ ì¶”ê°€ (ì‚¬ìš©ì HTML í¸ì§‘ìš©ì´ë¼ë©´) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const dropZone = document.getElementById("dropZone");
      const previewArea = document.getElementById("previewArea");

    });

    $(document).ready(function () {
      editor = CodeMirror.fromTextArea($(".codemirror-textarea")[0], {
        lineNumbers: true,
        mode: "htmlmixed"
      });

      // 2. ë¶™ì—¬ë„£ê¸° ì‹œ ê¸°ë³¸ text/plain ì‚½ì… ì°¨ë‹¨ (ì½”ì–´ ë ˆë²¨)
      CodeMirror.on(editor, "beforeChange", function (instance, changeObj) {
        if (changeObj.origin === "paste" && changeObj.text && changeObj.text.length > 1) {
          // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° í…ìŠ¤íŠ¸ ì œê±°
          changeObj.cancel();
        }
      });

      editor.getWrapperElement().addEventListener('paste', function (e) {
        e.preventDefault(); // ğŸ’¥ í•­ìƒ ë¶™ì—¬ë„£ê¸° ê¸°ë³¸ ë™ì‘ ë§‰ê¸°

        // í´ë¦½ë³´ë“œì—ì„œ HTML ë°ì´í„° ì¶”ì¶œ
        const htmlData = e.clipboardData.getData('text/html');

        // HTML ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë°©ì§€í•˜ê³  ì§ì ‘ ì‚½ì…
        if (htmlData) {
          e.preventDefault();
          const doc = editor.getDoc();
          const cursor = doc.getCursor();
          doc.replaceRange(extractFragment(htmlData), cursor);
        }
        // HTMLì´ ì—†ì„ ê²½ìš° ê¸°ì¡´ ê¸°ë³¸ ë™ì‘ ìœ ì§€ (text/plain)
      });



      // HTML ë³µì‚¬ ë²„íŠ¼
      document.getElementById('copyHTMLBtn').addEventListener('click', () => {
        const html = getIframeHTML();
        navigator.clipboard.writeText(html).then(() => {
          alert('HTMLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }).catch(err => {
          alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
        });
      });

      // HTML ì €ì¥ ë²„íŠ¼
      document.getElementById('saveHTMLBtn').addEventListener('click', () => {
        const filename = document.getElementById('filenameInput').value.trim() || 'roll20-wrap';

        const html = getIframeHTML();
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename + '.html';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      // TXT ì €ì¥ ë²„íŠ¼
      document.getElementById('saveTxtBtn').addEventListener('click', () => {
        const filename = document.getElementById('filenameInput').value.trim() || 'roll20-wrap';

        const html = getIframeHTML();
        const blob = new Blob([html], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename + '.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      });



      $("#applyStyleBtn").on("click", function () {
        const htmlCode = editor.getValue();
        const iframe = document.getElementById("preview");
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        let lineH = $("#paddingInput").val();
        doc.open();
        doc.write(htmlCode);
        doc.close();


        // ë Œë” ì™„ë£Œ í›„ ìŠ¤íƒ€ì¼ ì ìš©
        iframe.onload = () => {

          // âœ… ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
          const style = doc.createElement("style");
          style.textContent = `
                
                  @font-face {
                    font-family: 'Pretendard-Regular';
                    src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
                    font-weight: 400;
                    font-style: normal;
                  }
                  body {
                    font-family: 'Pretendard-Regular';
                  }
                  * {
                    line-height: ${lineH} !important;
                  }
                    .inlinerollresult{
                    line-height: 2.5 !important;
                    }
              `;
          doc.head.appendChild(style);


          if (document.getElementById("colorUnifyCheckbox").checked) {
            doc.querySelectorAll(".you").forEach(el => {
              el.style.backgroundColor = "rgb(241, 241, 241)";
            });
            doc.querySelectorAll(".you > .spacer").forEach(el => {
              el.style.backgroundColor = "rgb(225, 225, 225)";
            });
          }

          if (document.getElementById("tableWidthCheckbox").checked) {
            doc.querySelectorAll("div.message.general table").forEach(table => {
              table.style.setProperty("width", "100%", "important");
            });
          }

          if (document.getElementById("removeApiCheckbox").checked) {
            doc.querySelectorAll("span").forEach(span => {
              if (span.style.color === "rgb(170, 170, 170)") {
                const parentDiv = span.closest("div");
                if (parentDiv) parentDiv.remove();
              }
            });
            let lastSpeaker = null;

            doc.querySelectorAll(".message").forEach(message => {
              // ë§Œì•½ descë©´ speaker íë¦„ì„ ëŠëŠ”ë‹¤ (lastSpeaker ë¬´íš¨í™”)
              if (message.classList.contains("desc")) {
                lastSpeaker = null;
                return;
              }

              const bySpan = message.querySelector("span.by");
              const avatar = message.querySelector("div.avatar");
              const currentSpeaker = bySpan ? bySpan.textContent.trim() : null;

              if (currentSpeaker && currentSpeaker === lastSpeaker) {


                // âœ… ì—°ì† ë°œí™”ì â†’ spacer ì œê±°
                const spacer = message.querySelector(".spacer");
                if (spacer) spacer.remove();
                if (bySpan) bySpan.remove();
                // âœ… ì´ë¦„(span.by)ë„ ì œê±°
                if (avatar) avatar.remove();
              }

              if (currentSpeaker) {
                lastSpeaker = currentSpeaker;
              } else {
                // í™”ìê°€ ì—†ìœ¼ë©´ í˜„ì¬ í™”ì ìœ ì§€ (desc ê°™ì€ ê²½ìš°)
                // lastSpeaker ìœ ì§€
              }
            });
          }

          if (document.getElementById("ownerInput").value.trim() !== "") {


            const targets = document.getElementById("ownerInput").value
              .split(",")
              .map(t => t.trim())
              .filter(t => t !== "");

            let deletingSpeaker = null;  // í˜„ì¬ ì‚­ì œ ì¤‘ì¸ ìŠ¤í”¼ì»¤

            doc.querySelectorAll(".message").forEach(message => {
              // ë©”ì‹œì§€ divì— 'desc' í´ë˜ìŠ¤ê°€ ìˆìœ¼ë©´ ì‚­ì œ ì œì™¸
              if (message.classList.contains("desc")) {
                // ì‚­ì œ ëŒ€ìƒ ì•„ë‹˜, ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°
                deletingSpeaker = null;
                return;
              }

              const bySpan = message.querySelector("span.by");

              if (bySpan) {
                const speaker = bySpan.textContent.trim();

                if (targets.some(name => speaker.includes(name))) {
                  // ëŒ€ìƒ ìŠ¤í”¼ì»¤ë¼ë©´ ì‚­ì œ ì‹œì‘
                  deletingSpeaker = speaker;
                  message.remove();
                } else {
                  // ëŒ€ìƒ ìŠ¤í”¼ì»¤ ì•„ë‹ˆë©´ ì‚­ì œ ì¤‘ì§€
                  deletingSpeaker = null;
                }
              } else {
                // span.by ì—†ìœ¼ë©´ ì—°ì† ë°œí™” ë©”ì‹œì§€ íŒë‹¨
                if (deletingSpeaker !== null) {
                  message.remove();
                }
              }
            });
          }



          if (document.getElementById("removeHiddenMessageCheckbox").checked) {
            doc.querySelectorAll("div.hidden-message").forEach(el => el.remove());
          }

          const inputText = document.getElementById("systemJournalInput").value.trim();
          if (inputText) {
            const messages = Array.from(doc.querySelectorAll("div.message"));
            let i = 0;

            while (i < messages.length) {
              const current = messages[i];

              const classList = current.classList;
              const hasSpacer = current.querySelector(".spacer") !== null;

              // whisper ë˜ëŠ” private í´ë˜ìŠ¤ê°€ ìˆëŠ” ê²½ìš° ì œì™¸
              if (classList.contains("whisper") || classList.contains("private")) {
                i++;
                continue;
              }

              if (hasSpacer && current.textContent.includes(inputText)) {
                const toConvert = [];
                toConvert.push(current);

                // ì—°ì†ëœ spacer ì—†ëŠ” ë©”ì‹œì§€ë“¤ ìˆ˜ì§‘
                let j = i + 1;
                while (j < messages.length && !messages[j].querySelector(".spacer")) {
                  toConvert.push(messages[j]);
                  j++;
                }

                // âœ… ê°œë³„ ë©”ì‹œì§€ë¡œ desc ìƒì„±
                toConvert.forEach(orig => {
                  const msgId = "descmsg-" + Date.now() + Math.floor(Math.random() * 1000);
                  let text = "";

                  const bySpan = orig.querySelector("span.by");
                  if (bySpan && bySpan.nextSibling) {
                    text = bySpan.nextSibling.textContent.trim();
                  } else {
                    text = orig.textContent.trim();
                  }

                  const descDiv = doc.createElement("div");
                  descDiv.className = "message desc";
                  descDiv.setAttribute("data-messageid", msgId);
                  descDiv.setAttribute("style",
                    "box-sizing: content-box; padding-left: 15px; padding-right: 16px; padding-bottom: 7px; background-color: rgb(241, 241, 241); position: relative; font-style: italic; font-weight: bold; text-align: center;");

                  descDiv.innerHTML = `
                        <div class="spacer" style="box-sizing: content-box; background-color: rgb(225, 225, 225); height: 2px; margin-bottom: 7px; margin-left: -15px; margin-right: -12px;"></div>
                        ${text}
                        <div id="menu-${msgId}" class="flyout" style="box-sizing: content-box; position: absolute; cursor: pointer; height: 24px; width: 2px; right: 10px; top: 0px;"></div>
                      `;

                  orig.parentNode.insertBefore(descDiv, orig);
                  orig.remove();
                });

                i = j;
              } else {
                i++;
              }
            }
          }


          //ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚­ì œ 
          doc.querySelectorAll('.message').forEach(msg => {
            const delBtn = doc.createElement('button');
            delBtn.textContent = 'âœ•';
            delBtn.style.cssText = `
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 50, 50, 0.8);
      border: none;
      color: white;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      z-index: 9999;
    `;

            // ë¶€ëª¨ .messageì— ìƒëŒ€ ìœ„ì¹˜ ì§€ì •
            msg.style.position = 'relative';
            msg.appendChild(delBtn);

            msg.addEventListener('mouseover', () => {
              delBtn.style.display = 'block';
            });
            msg.addEventListener('mouseleave', () => {
              delBtn.style.display = 'none';
            });

            delBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              // (ì„ íƒ) ì´ì „ ìš”ì†Œê°€ <hr>ì´ë©´ ê°™ì´ ì‚­ì œ
              const prev = msg.previousElementSibling;
              if (prev && prev.tagName === 'HR') {
                prev.remove();
              }
              msg.remove();
            });
          });

          const whisperColor = document.getElementById("whisperColorInput").value || "#000000";
          const whisperBColor = document.getElementById("whisperBColorInput").value || "#ddd";
          const whisperBSpacerColor = darkenColor(whisperBColor, 12); // ë°ê¸° ì°¨ì´ ì¡°ì ˆ

          doc.querySelectorAll('.whisper').forEach(whisper => {
            // ê·“ì†ë§ ë°°ê²½ìƒ‰
            whisper.style.backgroundColor = whisperBColor;
            whisper.style.color = whisperColor;
          });
          //ê·“ì†ë§ ì„ ìƒ‰
          doc.querySelectorAll(".whisper > .spacer").forEach(el => {
            el.style.backgroundColor = whisperBSpacerColor;
          });

          const emoteColor = document.getElementById("emoteColorInput").value || "#653e10";
          const emoteBColor = document.getElementById("emoteBColorInput").value || "#d3cbb6";
          const emoteBSpacerColor = darkenColor(emoteBColor, 12); // ë°ê¸° ì°¨ì´ ì¡°ì ˆ

          //emas ë°°ê²½ìƒ‰
          doc.querySelectorAll('.emote').forEach(emote => {
            emote.style.backgroundColor = emoteBColor;
            emote.style.color = emoteColor;
          });
          //emas ì„ ìƒ‰
          doc.querySelectorAll(".emote > .spacer").forEach(el => {
            el.style.backgroundColor = emoteBSpacerColor;
          });

          // ë”ë¸”í´ë¦­ ìˆ˜ì •
          doc.querySelectorAll('.message').forEach(span => {
            span.addEventListener('dblclick', () => {
              span.setAttribute('contenteditable', 'true');
              span.focus();
            });
            span.addEventListener('blur', () => {
              span.removeAttribute('contenteditable');
            });
            span.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                span.blur();
              }
            });
          });



        }

      });

    });

    function darkenColor(hex, amount = 15) {
      const num = parseInt(hex.slice(1), 16);
      const r = Math.max(0, (num >> 16) - amount);
      const g = Math.max(0, ((num >> 8) & 0x00FF) - amount);
      const b = Math.max(0, (num & 0x0000FF) - amount);
      return `rgb(${r}, ${g}, ${b})`;
    }

    // iframeì—ì„œ HTML ë¬¸ìì—´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getIframeHTML() {
      const iframe = document.getElementById('preview');
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      return doc.documentElement.outerHTML;
    }

    function extractFragment(html) {
      const START = '<!--StartFragment-->';
      const END = '<!--EndFragment-->';

      const startIndex = html.indexOf(START);
      const endIndex = html.indexOf(END);

      if (startIndex === -1 || endIndex === -1) {
        // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë¦¬í„´ (fallback)
        return html;
      }

      return html.substring(startIndex + START.length, endIndex);
    }


  </script>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <h2>ê»ì§ˆ ë¯¸ë¦¬-ê¹ ë¡¤20ë¡œê·¸</h2>
      <p style="font-size:10pt;">
        ë¡¤20 ë¡œê·¸ë¥¼ ê¹”ë”í•œ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•´ì£¼ëŠ” í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.
        <br />
        í˜¼ìì„œ ì½˜ì†”ì°½ì— ì…ë ¥í•´ê°€ë©´ì„œ ì“°ë‹¤ê°€ ë”¸ê¹ì´ í•„ìš”í•´ì„œ ë§Œë“¤ì—ˆì–´ìš”...
        <br />
        ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ë©´ @waSANkkuë¡œ ì—°ë½ì£¼ì‹œê¸¸...
      </p>
      <div id="editor" style="border: 1px solid #ccc;"><textarea class="codemirror-textarea"></textarea></div>

      <label><input type="checkbox" id="tableWidthCheckbox" checked /> í‘œ ë„ˆë¹„ ë§ì¶”ê¸°</label>
      <label><input type="checkbox" id="colorUnifyCheckbox" checked /> ë‚´ê°€ ë³´ë‚¸ ì±„íŒ… ìƒ‰ìƒ í†µì¼</label>
      <label><input type="checkbox" id="removeApiCheckbox" checked /> ì‚¬ë‹´ API ì¼ê´„ì œê±° </label>
      <label><input type="checkbox" id="removeHiddenMessageCheckbox" checked /> ìˆ¨ê¸´ ë©”ì„¸ì§€ ì¼ê´„ì œê±° </label>
      <label>
        ì‹œìŠ¤í…œ ì €ë„ ëª…:
        <input type="text" id="systemJournalInput" />
      </label>
      <label>
        ì €ë„ ì¼ê´„ ì‚­ì œ:
        <input type="text" id="ownerInput" />
      </label>
      <label>
        ì¤„ ê°„ê²©:
        <input type="number" id="paddingInput" value="1.5" min="0" />
      </label>
      <div>
        <label>
          ê·“ì†ë§ ë°°ê²½ìƒ‰:
          <input type="color" id="whisperBColorInput" value="#dddddd" />
        </label>
        <label>
          ê·“ì†ë§ ê¸€ììƒ‰:
          <input type="color" id="whisperColorInput" value="#000000" />
        </label>
      </div>
      <div>
        <label>
          emas ë°°ê²½ìƒ‰:
          <input type="color" id="emoteBColorInput" value="#d3cbb6" />
        </label>
        <label>
          emas ê¸€ììƒ‰:
          <input type="color" id="emoteColorInput" value="#653e10" />
        </label>
      </div>


      <input type="text" id="filenameInput" placeholder="íŒŒì¼ëª… ì…ë ¥ (í™•ì¥ì ì œì™¸)" />
      <button id="applyStyleBtn">ìŠ¤íƒ€ì¼ ì ìš©</button>
      <button id="copyHTMLBtn">HTML ë³µì‚¬</button>
      <button id="saveHTMLBtn">HTML ì €ì¥</button>
      <button id="saveTxtBtn">TXT ì €ì¥</button>
    </div>

    <div class="preview-container">
      <iframe id="preview"></iframe>
    </div>
  </div>

  <script>

  </script>
</body>

</html>
