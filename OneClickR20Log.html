<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ì›í´ë¦­ ë¡¤20 ìŠ¤íƒ€ì¼</title>
  <style>
    @font-face {
      font-family: 'Pretendard-Regular';
      src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Pretendard-Regular';
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      padding: 20px;
      background-color: #f7f7f7;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .drop-zone {
      border: 2px dashed #aaa;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: #666;
      background-color: #fff;
      transition: background-color 0.3s, border-color 0.3s;
      cursor: pointer;
    }

    .drop-zone.dragover {
      background-color: #eef6ff;
      border-color: #3399ff;
      color: #3399ff;
    }

    .preview-container {
      flex: 1;
      height: 100%;
      overflow: auto;
      background-color: #1f1e22;
      color: white;
      padding: 10px;
    }

    #preview {
      flex: 1;
      width: 100%;
      height: 100%;
    }

    button {
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
    }

    label {
      font-size: 14px;
    }

    input[type="number"] {
      width: 60px;
      padding: 5px;
      margin-left: 5px;
    }

    .CodeMirror {
      height: 100px !important;
    }

    #splitList li {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    #splitList li:hover {
      background-color: #e0e7ff;
    }
    .title{
      font-size: 15pt;
      font-weight: bold;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <!-- âœ… CodeMirror 5 CSS & JS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

  <!-- âœ… ì„ íƒì ìœ¼ë¡œ HTML ëª¨ë“œ ì¶”ê°€ (ì‚¬ìš©ì HTML í¸ì§‘ìš©ì´ë¼ë©´) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const dropZone = document.getElementById("dropZone");
      const previewArea = document.getElementById("previewArea");

    });

    $(document).ready(function () {
      editor = CodeMirror.fromTextArea($(".codemirror-textarea")[0], {
        lineNumbers: true,
        mode: "htmlmixed"
      });

      // 2. ë¶™ì—¬ë„£ê¸° ì‹œ ê¸°ë³¸ text/plain ì‚½ì… ì°¨ë‹¨ (ì½”ì–´ ë ˆë²¨)
      CodeMirror.on(editor, "beforeChange", function (instance, changeObj) {
        if (changeObj.origin === "paste" && changeObj.text && changeObj.text.length > 1) {
          // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° í…ìŠ¤íŠ¸ ì œê±°
          changeObj.cancel();
        }
      });

      editor.getWrapperElement().addEventListener('paste', function (e) {
        e.preventDefault(); // ğŸ’¥ í•­ìƒ ë¶™ì—¬ë„£ê¸° ê¸°ë³¸ ë™ì‘ ë§‰ê¸°

        // í´ë¦½ë³´ë“œì—ì„œ HTML ë°ì´í„° ì¶”ì¶œ
        const htmlData = e.clipboardData.getData('text/html');

        // HTML ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë°©ì§€í•˜ê³  ì§ì ‘ ì‚½ì…
        if (htmlData) {
          e.preventDefault();
          const doc = editor.getDoc();
          const cursor = doc.getCursor();
          doc.replaceRange(extractFragment(htmlData), cursor);
        }
        // HTMLì´ ì—†ì„ ê²½ìš° ê¸°ì¡´ ê¸°ë³¸ ë™ì‘ ìœ ì§€ (text/plain)
      });



      // HTML ë³µì‚¬ ë²„íŠ¼
      document.getElementById('copyHTMLBtn').addEventListener('click', () => {
        const html = getIframeHTML();
        navigator.clipboard.writeText(html).then(() => {
          alert('HTMLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }).catch(err => {
          alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
        });
      });

      // HTML ì €ì¥ ë²„íŠ¼
      document.getElementById('saveHTMLBtn').addEventListener('click', () => {
        const filename = document.getElementById('filenameInput').value.trim() || 'roll20-wrap';

        if (splitHtmls.length > 0 && currentSplitIndex !== null) {
          content = wrapHTML(splitHtmls[currentSplitIndex].html);
        } else {
          content = getIframeHTML();
        }
        const html = getIframeHTML();
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename + '.html';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      // TXT ì €ì¥ ë²„íŠ¼
      document.getElementById('saveTxtBtn').addEventListener('click', () => {
        const filename = document.getElementById('filenameInput').value.trim() || 'roll20-wrap';

        if (splitHtmls.length > 0 && currentSplitIndex !== null) {
          // ë¶„í• ëœ í•­ëª© ì¤‘ í˜„ì¬ ì„ íƒëœ ê²ƒë§Œ
          content = stripHTML(splitHtmls[currentSplitIndex].html);
        } else {
          // ì „ì²´ iframe ë‚´ìš©
          content = stripHTML(getIframeHTML());
        }
        const html = getIframeHTML();
        const blob = new Blob([html], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename + '.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      });



      $("#applyStyleBtn").on("click", function () {
        const htmlCode = editor.getValue();
        const iframe = document.getElementById("preview");
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        let lineH = $("#paddingInput").val();
        doc.open();
        doc.write(htmlCode);
        doc.close();

        // ë©”ì‹œì§€ë§Œ ì¶”ì¶œí•´ì„œ ì „ì²´ ë¶„í•  ë°ì´í„° ì´ˆê¸°í™”
          const messages = Array.from(doc.querySelectorAll('.message'));
          const totalCount = messages.length;
          const fullHtml = messages.map(m => m.outerHTML).join('\n');

          splitHtmls = {};
          currentSplitKey = `1-${totalCount}`;
          splitHtmls[currentSplitKey] = fullHtml;

          updateSplitListUI();
        // ë Œë” ì™„ë£Œ í›„ ìŠ¤íƒ€ì¼ ì ìš©
        iframe.onload = () => {

          // âœ… ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
          const style = doc.createElement("style");
          style.textContent = `
                
                  @font-face {
                    font-family: 'Pretendard-Regular';
                    src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
                    font-weight: 400;
                    font-style: normal;
                  }
                  body {
                    font-family: 'Pretendard-Regular';
                  }
                  * {
                    line-height: ${lineH} !important;
                  }
                    .inlinerollresult{
                    line-height: 2.5 !important;
                    }
              `;
          doc.head.appendChild(style);


          if (document.getElementById("colorUnifyCheckbox").checked) {
            doc.querySelectorAll(".you").forEach(el => {
              el.style.backgroundColor = "rgb(241, 241, 241)";
            });
            doc.querySelectorAll(".you > .spacer").forEach(el => {
              el.style.backgroundColor = "rgb(225, 225, 225)";
            });
          }

          if (document.getElementById("tableWidthCheckbox").checked) {
            doc.querySelectorAll("div.message.general table").forEach(table => {
              table.style.setProperty("width", "100%", "important");
            });
          }

          if (document.getElementById("removeApiCheckbox").checked) {
            doc.querySelectorAll("span").forEach(span => {
              if (span.style.color === "rgb(170, 170, 170)") {
                const parentDiv = span.closest("div");
                if (parentDiv) parentDiv.remove();
              }
            });
            let lastSpeaker = null;

            doc.querySelectorAll(".message").forEach(message => {
              // ë§Œì•½ descë©´ speaker íë¦„ì„ ëŠëŠ”ë‹¤ (lastSpeaker ë¬´íš¨í™”)
              if (message.classList.contains("desc")) {
                lastSpeaker = null;
                return;
              }

              const bySpan = message.querySelector("span.by");
              const avatar = message.querySelector("div.avatar");
              const currentSpeaker = bySpan ? bySpan.textContent.trim() : null;

              if (currentSpeaker && currentSpeaker === lastSpeaker) {


                // âœ… ì—°ì† ë°œí™”ì â†’ spacer ì œê±°
                const spacer = message.querySelector(".spacer");
                if (spacer) spacer.remove();
                if (bySpan) bySpan.remove();
                // âœ… ì´ë¦„(span.by)ë„ ì œê±°
                if (avatar) avatar.remove();
              }

              if (currentSpeaker) {
                lastSpeaker = currentSpeaker;
              } else {
                // í™”ìê°€ ì—†ìœ¼ë©´ í˜„ì¬ í™”ì ìœ ì§€ (desc ê°™ì€ ê²½ìš°)
                // lastSpeaker ìœ ì§€
              }
            });
          }

          if (document.getElementById("ownerInput").value.trim() !== "") {


            const targets = document.getElementById("ownerInput").value
              .split(",")
              .map(t => t.trim())
              .filter(t => t !== "");

            let deletingSpeaker = null;  // í˜„ì¬ ì‚­ì œ ì¤‘ì¸ ìŠ¤í”¼ì»¤

            doc.querySelectorAll(".message").forEach(message => {
              // ë©”ì‹œì§€ divì— 'desc' í´ë˜ìŠ¤ê°€ ìˆìœ¼ë©´ ì‚­ì œ ì œì™¸
              if (message.classList.contains("desc")) {
                // ì‚­ì œ ëŒ€ìƒ ì•„ë‹˜, ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°
                deletingSpeaker = null;
                return;
              }

              const bySpan = message.querySelector("span.by");

              if (bySpan) {
                const speaker = bySpan.textContent.trim();

                if (targets.some(name => speaker.includes(name))) {
                  // ëŒ€ìƒ ìŠ¤í”¼ì»¤ë¼ë©´ ì‚­ì œ ì‹œì‘
                  deletingSpeaker = speaker;
                  message.remove();
                } else {
                  // ëŒ€ìƒ ìŠ¤í”¼ì»¤ ì•„ë‹ˆë©´ ì‚­ì œ ì¤‘ì§€
                  deletingSpeaker = null;
                }
              } else {
                // span.by ì—†ìœ¼ë©´ ì—°ì† ë°œí™” ë©”ì‹œì§€ íŒë‹¨
                if (deletingSpeaker !== null) {
                  message.remove();
                }
              }
            });
          }



          if (document.getElementById("removeHiddenMessageCheckbox").checked) {
            doc.querySelectorAll("div.hidden-message").forEach(el => el.remove());
          }

          const inputText = document.getElementById("systemJournalInput").value.trim();
          if (inputText) {
            const messages = Array.from(doc.querySelectorAll("div.message"));
            let i = 0;

            while (i < messages.length) {
              const current = messages[i];

              const classList = current.classList;
              const hasSpacer = current.querySelector(".spacer") !== null;

              // whisper ë˜ëŠ” private í´ë˜ìŠ¤ê°€ ìˆëŠ” ê²½ìš° ì œì™¸
              if (classList.contains("whisper") || classList.contains("private")) {
                i++;
                continue;
              }

              if (hasSpacer && current.textContent.includes(inputText)) {
                const toConvert = [];
                toConvert.push(current);

                // ì—°ì†ëœ spacer ì—†ëŠ” ë©”ì‹œì§€ë“¤ ìˆ˜ì§‘
                let j = i + 1;
                while (j < messages.length && !messages[j].querySelector(".spacer")) {
                  toConvert.push(messages[j]);
                  j++;
                }

                // âœ… ê°œë³„ ë©”ì‹œì§€ë¡œ desc ìƒì„±
                toConvert.forEach(orig => {
                  const msgId = "descmsg-" + Date.now() + Math.floor(Math.random() * 1000);
                  let text = "";

                  const bySpan = orig.querySelector("span.by");
                  if (bySpan && bySpan.nextSibling) {
                    text = bySpan.nextSibling.textContent.trim();
                  } else {
                    text = orig.textContent.trim();
                  }

                  const descDiv = doc.createElement("div");
                  descDiv.className = "message desc";
                  descDiv.setAttribute("data-messageid", msgId);
                  descDiv.setAttribute("style",
                    "box-sizing: content-box; padding-left: 15px; padding-right: 16px; padding-bottom: 7px; background-color: rgb(241, 241, 241); position: relative; font-style: italic; font-weight: bold; text-align: center;");

                  descDiv.innerHTML = `
                        <div class="spacer" style="box-sizing: content-box; background-color: rgb(225, 225, 225); height: 2px; margin-bottom: 7px; margin-left: -15px; margin-right: -12px;"></div>
                        ${text}
                        <div id="menu-${msgId}" class="flyout" style="box-sizing: content-box; position: absolute; cursor: pointer; height: 24px; width: 2px; right: 10px; top: 0px;"></div>
                      `;

                  orig.parentNode.insertBefore(descDiv, orig);
                  orig.remove();
                });

                i = j;
              } else {
                i++;
              }
            }
          }


          //ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚­ì œ 
          doc.querySelectorAll('.message').forEach(msg => {
            const delBtn = doc.createElement('button');
            delBtn.textContent = 'âœ•';
            delBtn.style.cssText = `
              position: absolute;
              top: 5px;
              right: 5px;
              background: rgba(255, 50, 50, 0.8);
              border: none;
              color: white;
              font-weight: bold;
              padding: 2px 6px;
              border-radius: 50%;
              cursor: pointer;
              display: none;
              z-index: 9999;
            `;

            // ë¶„í•  ë²„íŠ¼ ìƒì„±
            const splitBtn = doc.createElement('button');
            splitBtn.textContent = 'ë¶„í• ';
            splitBtn.className = 'split-btn';
            splitBtn.style.cssText = `
              position: absolute;
              top: 5px;
              right: 40px;
              background: rgba(50, 100, 255, 0.8);
              border: none;
              color: white;
              font-weight: bold;
              padding: 2px 6px;
              border-radius: 4px;
              cursor: pointer;
              display: none;
              z-index: 9999;
            `;


            // ë¶€ëª¨ .messageì— ìƒëŒ€ ìœ„ì¹˜ ì§€ì •
            msg.style.position = 'relative';
            msg.appendChild(delBtn);

            msg.appendChild(splitBtn);

            msg.addEventListener('mouseover', () => {
              delBtn.style.display = 'block';
              splitBtn.style.display = 'block';
            });
            msg.addEventListener('mouseleave', () => {
              delBtn.style.display = 'none';
              splitBtn.style.display = 'none';
            });

                

            splitBtn.addEventListener('click', e => {
              e.stopPropagation();
              splitAtMessageIndex(doc, msg);
            });

            delBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              // (ì„ íƒ) ì´ì „ ìš”ì†Œê°€ <hr>ì´ë©´ ê°™ì´ ì‚­ì œ
              const prev = msg.previousElementSibling;
              if (prev && prev.tagName === 'HR') {
                prev.remove();
              }
              msg.remove();
              // ì‚­ì œ í›„ í˜„ì¬ ë¶„í•  êµ¬ê°„ ë‚´ìš© ì €ì¥ ê°±ì‹ 
             saveCurrentSplitList();
            });
          });

          const whisperColor = document.getElementById("whisperColorInput").value || "#000000";
          const whisperBColor = document.getElementById("whisperBColorInput").value || "#ddd";
          const whisperBSpacerColor = darkenColor(whisperBColor, 12); // ë°ê¸° ì°¨ì´ ì¡°ì ˆ

          doc.querySelectorAll('.whisper').forEach(whisper => {
            // ê·“ì†ë§ ë°°ê²½ìƒ‰
            whisper.style.backgroundColor = whisperBColor;
            whisper.style.color = whisperColor;
          });
          //ê·“ì†ë§ ì„ ìƒ‰
          doc.querySelectorAll(".whisper > .spacer").forEach(el => {
            el.style.backgroundColor = whisperBSpacerColor;
          });

          const emoteColor = document.getElementById("emoteColorInput").value || "#653e10";
          const emoteBColor = document.getElementById("emoteBColorInput").value || "#d3cbb6";
          const emoteBSpacerColor = darkenColor(emoteBColor, 12); // ë°ê¸° ì°¨ì´ ì¡°ì ˆ

          //emas ë°°ê²½ìƒ‰
          doc.querySelectorAll('.emote').forEach(emote => {
            emote.style.backgroundColor = emoteBColor;
            emote.style.color = emoteColor;
          });
          //emas ì„ ìƒ‰
          doc.querySelectorAll(".emote > .spacer").forEach(el => {
            el.style.backgroundColor = emoteBSpacerColor;
          });

          // ë”ë¸”í´ë¦­ ìˆ˜ì •
          doc.querySelectorAll('.message').forEach(span => {
            span.addEventListener('dblclick', () => {
              span.setAttribute('contenteditable', 'true');
              span.focus();
            });
            span.addEventListener('blur', () => {
              span.removeAttribute('contenteditable');
              saveCurrentSplitList();

            });
             span.addEventListener('keydown', (e) => {
             if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                span.blur(); // ìˆ˜ì • ì¢…ë£Œ
              }
            });
            // âœ… ë¶™ì—¬ë„£ê¸° ì´ë¯¸ì§€ ì²˜ë¦¬(0628)
            span.addEventListener('paste', (e) => {
              const items = e.clipboardData.items;

              for (let i = 0; i < items.length; i++) {
                const item = items[i];

                if (item.type.indexOf('image') !== -1) {
                  e.preventDefault(); // base64 ì‚½ì… ë°©ì§€

                  const file = item.getAsFile();
                  const reader = new FileReader();

                  reader.onload = (event) => {
                    // canvasë¡œ WebPë¡œ ì••ì¶•
                    const img = new Image();
                    img.onload = () => {
                      const canvas = document.createElement('canvas');
                      canvas.width = img.width;
                      canvas.height = img.height;
                      const ctx = canvas.getContext('2d');
                      ctx.drawImage(img, 0, 0);
                      const webpDataUrl = canvas.toDataURL('image/webp', 0.5); // í’ˆì§ˆ ì¡°ì • ê°€ëŠ¥
                      const imageEl = document.createElement('img');
                      imageEl.src = webpDataUrl;
                      span.appendChild(imageEl);
                    };
                    img.src = event.target.result;
                  };

                  reader.readAsDataURL(file); // ìµœì´ˆëŠ” base64ì§€ë§Œ ì••ì¶•í•´ì„œ ì¬ì‚½ì…
                  break; // í•˜ë‚˜ë§Œ ì²˜ë¦¬
                }
              }
            });
          });

        }

      });

    });

    function darkenColor(hex, amount = 15) {
      const num = parseInt(hex.slice(1), 16);
      const r = Math.max(0, (num >> 16) - amount);
      const g = Math.max(0, ((num >> 8) & 0x00FF) - amount);
      const b = Math.max(0, (num & 0x0000FF) - amount);
      return `rgb(${r}, ${g}, ${b})`;
    }

    // iframeì—ì„œ HTML ë¬¸ìì—´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getIframeHTML() {
      const iframe = document.getElementById('preview');
      const doc = iframe.contentDocument || iframe.contentWindow.document;

    // âœ… ì›ë³¸ í›¼ì† ë°©ì§€: documentElement ë³µì œ
    const clone = doc.documentElement.cloneNode(true);

    // âœ… ë¶„í•  ë²„íŠ¼ ì œê±°
    clone.querySelectorAll('button.split-btn').forEach(btn => btn.remove());

    // âœ… ì‚­ì œ ë²„íŠ¼(âœ•) ì œê±°
    clone.querySelectorAll('button').forEach(btn => {
      if (btn.textContent === 'âœ•') btn.remove();
    });
  // ë³µì œí•œ ë…¸ë“œì˜ HTML ë¬¸ìì—´ ë°˜í™˜
    return clone.outerHTML;
    }

    function extractFragment(html) {
      const START = '<!--StartFragment-->';
      const END = '<!--EndFragment-->';

      const startIndex = html.indexOf(START);
      const endIndex = html.indexOf(END);

      if (startIndex === -1 || endIndex === -1) {
        // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë¦¬í„´ (fallback)
        return html;
      }

      return html.substring(startIndex + START.length, endIndex);
    }


    //HTMl ë¶„ë¦¬ (0628)
        
    function stripHTML(html) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      return tempDiv.textContent || tempDiv.innerText || '';
    }
    // iframe ë‚´ ë©”ì‹œì§€ë³„ë¡œ ì‚­ì œ ë²„íŠ¼ ì˜†ì— ë¶„í•  ë²„íŠ¼ ì¶”ê°€
    function addButtonsToMessages(doc) {
      doc.querySelectorAll('.message').forEach(msg => {
        if (msg.querySelector('.split-btn')) return; // ì¤‘ë³µë°©ì§€

        // ì‚­ì œ ë²„íŠ¼ ìƒì„± (ê¸°ì¡´ ì½”ë“œì—ì„œ ê°€ì ¸ì˜´)
        const delBtn = doc.createElement('button');
        delBtn.textContent = 'âœ•';
        delBtn.style.cssText = `
          position: absolute;
          top: 5px;
          right: 5px;
          background: rgba(255, 50, 50, 0.8);
          border: none;
          color: white;
          font-weight: bold;
          padding: 2px 6px;
          border-radius: 50%;
          cursor: pointer;
          display: none;
          z-index: 9999;
        `;

        // ë¶„í•  ë²„íŠ¼ ìƒì„±
        const splitBtn = doc.createElement('button');
        splitBtn.textContent = 'ë¶„í• ';
        splitBtn.className = 'split-btn';
        splitBtn.style.cssText = `
          position: absolute;
          top: 5px;
          right: 40px;
          background: rgba(50, 100, 255, 0.8);
          border: none;
          color: white;
          font-weight: bold;
          padding: 2px 6px;
          border-radius: 4px;
          cursor: pointer;
          display: none;
          z-index: 9999;
        `;

        msg.style.position = 'relative';
        msg.appendChild(delBtn);
        msg.appendChild(splitBtn);

        msg.addEventListener('mouseover', () => {
          delBtn.style.display = 'block';
          splitBtn.style.display = 'block';
        });
        msg.addEventListener('mouseleave', () => {
          delBtn.style.display = 'none';
          splitBtn.style.display = 'none';
        });

        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          const prev = msg.previousElementSibling;
          if (prev && prev.tagName === 'HR') prev.remove();
          msg.remove();

          // ì‚­ì œ í›„ í˜„ì¬ ë¶„í•  êµ¬ê°„ ë‚´ìš© ì €ì¥ ê°±ì‹ 
          saveCurrentSplitList();
        });

        splitBtn.addEventListener('click', e => {
          e.stopPropagation();
          splitAtMessageIndex(doc, msg);
        });
      });
    }
    // ì „ì—­ ë³€ìˆ˜
    let splitHtmls = {};
    let currentSplitKey = '';
    // ë¶„í•  ì²˜ë¦¬ í•¨ìˆ˜ - í´ë¦­í•œ ë©”ì‹œì§€ ê¸°ì¤€ìœ¼ë¡œ ë¶„í• 
      
    function splitAtMessageIndex(doc, clickedMsg) {
      const messages = Array.from(doc.querySelectorAll('.message'));
      const idx = messages.indexOf(clickedMsg);
      if (idx === -1) return;

      // ì•ë¶€ë¶„, ë’·ë¶€ë¶„ ë©”ì‹œì§€ ë¶„ë¦¬
      const part1 = messages.slice(0, idx + 1);
      const part2 = messages.slice(idx + 1);

      // outerHTML í•©ì¹˜ê¸°
      const htmlPart1 = part1.map(m => m.outerHTML).join('\n');
      const htmlPart2 = part2.map(m => m.outerHTML).join('\n');

      // ê¸°ì¡´ í˜„ì¬ ë¶„í•  í‚¤ ì‚­ì œ
      if (currentSplitKey && splitHtmls[currentSplitKey]) {
        delete splitHtmls[currentSplitKey];
      }

      // ìƒˆë¡œìš´ ë¶„í•  í‚¤ ìƒì„±
      const total = messages.length;
      const key1 = `1-${idx + 1}`;
      const key2 = `${idx + 2}-${total}`;

      // ë¶„í•  ë°ì´í„° ì €ì¥
      splitHtmls[key1] = htmlPart1;
      splitHtmls[key2] = htmlPart2;

      // í˜„ì¬ í‚¤ë¥¼ ì²« íŒŒíŠ¸ë¡œ ì„¤ì • (ì˜ˆ: 1~idx+1)
      currentSplitKey = key1;

      // ë¦¬ìŠ¤íŠ¸ UI ê°±ì‹ 
      updateSplitListUI();

       // ì²« ë²ˆì§¸ ë¶„í•  êµ¬ê°„ iframeì— ë¡œë“œ + ìŠ¤í¬ë¡¤ ìµœìƒë‹¨ ì´ë™
      loadHTMLtoIframe(htmlPart1);
      const iframe = document.getElementById('preview');
      iframe.contentWindow.scrollTo(0, 0);
    }

    function updateSplitListUI() {
      const splitList = document.getElementById('splitList');
      splitList.innerHTML = ''; // ì´ˆê¸°í™”

      Object.entries(splitHtmls).forEach(([key, html],i ) => {
        const li = document.createElement('li');
          li.textContent = `(${i + 1})`;  // (1), (2), (3) ... ìˆœì„œëŒ€ë¡œ í‘œì‹œ

        li.style.userSelect = 'none';
        li.style.cursor = 'pointer';

        li.addEventListener('click', () => {
          loadHTMLtoIframe(html);
          currentSplitKey = key;
        });

        splitList.appendChild(li);
      });
    }

    function saveCurrentSplitList() {
      const iframe = document.getElementById('preview');
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      if (!currentSplitKey) return;

      const messages = Array.from(doc.querySelectorAll('.message'));
      const html = messages.map(m => m.outerHTML).join('\n');

      splitHtmls[currentSplitKey] = html;
      editor.setValue(html);

      console.log(`í˜„ì¬ ë¶„í•  êµ¬ê°„(${currentSplitKey}) ë‚´ìš© ì €ì¥ë¨`);
      updateSplitListUI();
    }
    let splitCount = 0; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

    function wrapHTML(innerHTML) {
      return `<!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Split</title>
    </head>
    <body>
    ${innerHTML}
    </body>
    </html>`;
    }

    function getCleanedIframeHTML() {
    const iframe = document.getElementById("preview");
    const doc = iframe.contentDocument || iframe.contentWindow.document;

    // âœ… ì›ë³¸ í›¼ì† ë°©ì§€ë¥¼ ìœ„í•´ ë³µì œ
    const clone = doc.documentElement.cloneNode(true);

    // âœ… ë³µì œë³¸ì—ì„œ ë²„íŠ¼ë“¤ ì œê±°
    clone.querySelectorAll('button.split-btn').forEach(btn => btn.remove());
    clone.querySelectorAll('button').forEach(btn => {
      if (btn.textContent === 'âœ•') btn.remove();
    });

    return '<!DOCTYPE html>\n' + clone.outerHTML;
  }
    // iframeì— HTML ë¡œë“œ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì ìš©ì€ ë”°ë¡œ í•„ìš”ì‹œ)
    function loadHTMLtoIframe(html) {
       const iframe = document.getElementById('preview');

    function onLoad() {
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      
      iframe.removeEventListener('load', onLoad);
      // iframe ë‚´ìš© ë³€ê²½ë˜ë©´ ìŠ¤í¬ë¡¤ ìµœìƒë‹¨ìœ¼ë¡œ
      iframe.contentWindow.scrollTo(0, 0);
    }

    iframe.addEventListener('load', onLoad);

    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();

    
    }

  </script>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <h2>ê»ì§ˆ ë¯¸ë¦¬-ê¹ ë¡¤20ë¡œê·¸</h2>
      <p style="font-size:10pt;">
        ë¡¤20 ë¡œê·¸ë¥¼ ê¹”ë”í•œ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•´ì£¼ëŠ” í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.
        <br />
        í˜¼ìì„œ ì½˜ì†”ì°½ì— ì…ë ¥í•´ê°€ë©´ì„œ ì“°ë‹¤ê°€ ë”¸ê¹ì´ í•„ìš”í•´ì„œ ë§Œë“¤ì—ˆì–´ìš”...
        <br />
        ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ë©´ @waSANkkuë¡œ ì—°ë½ì£¼ì‹œê¸¸...
      </p>
      <div id="editor" style="border: 1px solid #ccc;"><textarea class="codemirror-textarea"></textarea></div>

      <label><input type="checkbox" id="tableWidthCheckbox" checked /> í‘œ ë„ˆë¹„ ë§ì¶”ê¸°</label>
      <label><input type="checkbox" id="colorUnifyCheckbox" checked /> ë‚´ê°€ ë³´ë‚¸ ì±„íŒ… ìƒ‰ìƒ í†µì¼</label>
      <label><input type="checkbox" id="removeApiCheckbox" checked /> ì‚¬ë‹´ API ì¼ê´„ì œê±° </label>
      <label><input type="checkbox" id="removeHiddenMessageCheckbox" checked /> ìˆ¨ê¸´ ë©”ì„¸ì§€ ì¼ê´„ì œê±° </label>
      <label>
        ì‹œìŠ¤í…œ ì €ë„ ëª…:
        <input type="text" id="systemJournalInput" />
      </label>
      <label>
        ì €ë„ ì¼ê´„ ì‚­ì œ:
        <input type="text" id="ownerInput" />
      </label>
      <label>
        ì¤„ ê°„ê²©:
        <input type="number" id="paddingInput" value="1.5" min="0" />
      </label>
      <div>
        <label>
          ê·“ì†ë§ ë°°ê²½ìƒ‰:
          <input type="color" id="whisperBColorInput" value="#dddddd" />
        </label>
        <label>
          ê·“ì†ë§ ê¸€ììƒ‰:
          <input type="color" id="whisperColorInput" value="#000000" />
        </label>
      </div>
      <div>
        <label>
          emas ë°°ê²½ìƒ‰:
          <input type="color" id="emoteBColorInput" value="#d3cbb6" />
        </label>
        <label>
          emas ê¸€ììƒ‰:
          <input type="color" id="emoteColorInput" value="#653e10" />
        </label>
      </div>

    <!-- ê¸°ì¡´ ì‚¬ì´ë“œë°” ë‚´ì— ì ë‹¹í•œ ìœ„ì¹˜ì— ì¶”ê°€ -->
    <div class="title">ë¶„í•  ëª©ë¡</div>
    <ul id="splitList" style="list-style:none; padding-left:0; max-height: 150px; overflow-y:auto; border:1px solid #ccc; margin-bottom:10px;"></ul>

      <input type="text" id="filenameInput" placeholder="íŒŒì¼ëª… ì…ë ¥ (í™•ì¥ì ì œì™¸)" />
      <button id="applyStyleBtn">ìŠ¤íƒ€ì¼ ì ìš©</button>
      <div>
        <button id="copyHTMLBtn">HTML ë³µì‚¬</button>
        <button id="saveHTMLBtn">HTML ì €ì¥</button>
        <button id="saveTxtBtn">TXT ì €ì¥</button>
      </div>
     
    </div>

    <div class="preview-container">
      <iframe id="preview"></iframe>
    </div>
  </div>

  <script>

  </script>
</body>

</html>
